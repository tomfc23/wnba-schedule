<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #output {
            white-space: pre-wrap;
            font-family: monospace;
            background: #f5f5f5;
            padding: 20px;
            margin-top: 20px;
            border-radius: 5px;
        }
        input[type="date"] {
            padding: 8px;
            margin: 10px 0;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #005a87;
        }
    </style>
</head>
<body>
    <h1>MLB & WNBA Schedule Viewer 3.1</h1>
    
    <div>
        <input type="date" id="datePicker" />
        <button onclick="showSchedule()">Show Schedule</button>
    </div>
    
    <div id="output"></div>

    <script>
        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTV0ITDll09moWFzxf29ma1yYwwuFoayx6La0Nm8ej_5MtjRh6s2GFqif2GEVR-hsBsy8cp8RqvJtzQ/pub?output=csv";
        let games = [];
        const columns = {
            mlb: { date: "MLB Date", time: "MLB Time", matchup: "MLB Matchup" },
            wnba: { date: "WNBA Date", time: "WNBA Time", matchup: "WNBA Matchup" }
        };

        Papa.parse(csvUrl, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
                // Remove completely empty rows
                games = results.data.filter(row => Object.values(row).some(val => val && val.trim() !== ""));
                if (games.length === 0) {
                    document.getElementById("output").innerText = "No schedule data loaded.";
                }
            },
            error: function (err) {
                document.getElementById("output").innerText = "Failed to load schedule data.";
            }
        });

        function showSchedule() {
            const inputDate = document.getElementById("datePicker").value;
            if (!inputDate) {
                document.getElementById("output").innerText = "Please select a date.";
                return;
            }

            const dateStr = formatToShortDate(inputDate);
            const selectedDate = new Date(inputDate);

            // Filter games for the selected date
            const mlbGames = games.filter(g => normalizeDate(g[columns.mlb.date]) === dateStr);
            const wnbaGames = games.filter(g => normalizeDate(g[columns.wnba.date]) === dateStr);

            const mlbTime = getEarliestTime(mlbGames, columns.mlb.time);
            const wnbaTime = getEarliestTime(wnbaGames, columns.wnba.time);

            const formattedDate = selectedDate.toLocaleDateString("en-US", {
                weekday: "long",
                month: "numeric",
                day: "numeric",
                year: "numeric"
            });

            let summary = `Games on ${formattedDate}:\n———————————————\n`;
            summary += `${mlbGames.length} MLB ${mlbTime ? `(${mlbTime})` : ''}\n`;
            summary += `${wnbaGames.length} WNBA ${wnbaTime ? `(${wnbaTime})` : ''}\n`;
            summary += `———————————————\n${mlbGames.length + wnbaGames.length} total games\n———————————————`;

            if (mlbGames.length > 0) {
                summary += `\n\nMLB Games:\n`;
                mlbGames.forEach(g => {
                    summary += `• ${g[columns.mlb.time] || "??"} — ${g[columns.mlb.matchup] || "[Matchup missing]"}\n`;
                });
            }
            if (wnbaGames.length > 0) {
                summary += `\nWNBA Games:\n`;
                wnbaGames.forEach(g => {
                    summary += `• ${g[columns.wnba.time] || "??"} — ${g[columns.wnba.matchup] || "[Matchup missing]"}\n`;
                });
            }
            if (mlbGames.length === 0 && wnbaGames.length === 0) {
                summary += `\nNo games found for this date.`;
            }

            document.getElementById("output").innerText = summary;
        }

        // Format as M/D/YY to match CSV export (removes leading zeroes)
        function formatToShortDate(dateStr) {
            const d = new Date(dateStr);
            const mm = d.getMonth() + 1;
            const dd = d.getDate();
            const yy = d.getFullYear().toString().slice(2);
            return `${mm}/${dd}/${yy}`;
        }

        // Handles leading zeros and inconsistent formats in CSV data
        function normalizeDate(dateVal) {
            if (!dateVal) return "";
            const d = new Date(dateVal);
            if (d.toString() === "Invalid Date") return (dateVal + "").trim(); // fallback to raw string
            return formatToShortDate(d.toISOString().slice(0,10));
        }

        function getEarliestTime(gameList, timeKey) {
            const validTimes = gameList
                .map(g => parseTime(g[timeKey]))
                .filter(t => t !== null)
                .sort((a, b) => a - b);
            return validTimes.length ? formatTime(validTimes[0]) : null;
        }

        // Robust time parsing: accepts "7:00 PM", "7:00PM", "07:00PM" (case-insensitive)
        function parseTime(str) {
            if (!str) return null;
            const match = (str.trim().match(/^(\d{1,2}):(\d{2})\s*([APap][Mm])$/) ||
                           str.trim().match(/^(\d{1,2}):(\d{2})\s*([APap][Mm])\.?$/) ||
                           str.trim().match(/^(\d{1,2}):(\d{2})\s*([APap][Mm])$/) ||
                           str.trim().match(/^(\d{1,2}):(\d{2})([APap][Mm])$/));
            if (!match) return null;
            let h = Number(match[1]);
            let m = Number(match[2]);
            let period = match[3].toUpperCase();
            if (period === "PM" && h < 12) h += 12;
            if (period === "AM" && h === 12) h = 0;
            return new Date(0, 0, 0, h, m);
        }

        function formatTime(date) {
            const h = date.getHours();
            const m = date.getMinutes().toString().padStart(2, '0');
            const suffix = h < 12 ? 'AM' : 'PM';
            const displayH = h % 12 || 12;
            return `${displayH}:${m} ${suffix}`;
        }
    </script>
</body>
</html>
