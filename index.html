<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real Sports Schedule</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: #fff; min-height: 100vh; color: #000; line-height: 1.5; }
.container { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
.header { text-align: center; margin-bottom: 60px; border-bottom: 1px solid #e5e5e5; padding-bottom: 30px; }
.header h1 { font-size: 2rem; font-weight: 400; margin-bottom: 8px; color: #000; letter-spacing: -0.02em; }
.header p { font-size: 0.95rem; color: #666; font-weight: 300; }
.controls { background: #fafafa; border: 1px solid #e5e5e5; border-radius: 4px; padding: 24px; margin-bottom: 40px; }
.control-group { display: flex; gap: 20px; align-items: end; flex-wrap: wrap; }
.control-item { display: flex; flex-direction: column; gap: 6px; }
.control-item label { font-weight: 400; color: #333; font-size: 0.9rem; }
.date-input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.95rem; background: #fff; color: #000; font-family: inherit; }
.date-input:focus { outline: none; border-color: #0066cc; }
.fetch-btn { padding: 9px 20px; background: #000; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-weight: 400; font-size: 0.95rem; font-family: inherit; transition: background-color 0.2s ease; }
.fetch-btn:hover { background: #333; }
.fetch-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.loading { text-align: center; padding: 60px 20px; color: #666; font-size: 0.95rem; }
.spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #e5e5e5; border-radius: 50%; border-top-color: #0066cc; animation: spin 1s linear infinite; margin-bottom: 12px; }
@keyframes spin { to { transform: rotate(360deg); } }
.error { background: #f8f8f8; border: 1px solid #ccc; color: #000; padding: 16px; border-radius: 3px; margin-bottom: 24px; font-size: 0.9rem; }
.schedule-container { background: #fff; border: 1px solid #e5e5e5; border-radius: 4px; overflow: hidden; display: none; }
.schedule-output, .breakdown-output { font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace; background: #fafafa; color: #000; padding: 20px; white-space: pre-wrap; font-size: 0.85rem; line-height: 1.6; overflow-x: auto; border-bottom: 1px solid #e5e5e5; }
.breakdown-output { background: #f5f5f5; border-bottom: none; }
.copy-btn { background: #0066cc; color: #fff; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 0.8rem; font-family: inherit; margin: 16px 20px 0 20px; transition: background-color 0.2s ease; }
.copy-btn:hover { background: #0052a3; }
@media (max-width: 768px) {
    .container { padding: 20px 16px; }
    .header { margin-bottom: 40px; }
    .header h1 { font-size: 1.75rem; }
    .control-group { flex-direction: column; align-items: stretch; gap: 16px; }
    .control-item { align-items: stretch; }
    .schedule-output, .breakdown-output { font-size: 0.8rem; padding: 16px; }
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Real Sports Schedule</h1>
        <p>‼️DOES NOT YET SUPPORT GOLF‼️</p><br>
        <p>dm @tomfc for problems</p>
    </div>

    <div class="controls">
        <div class="control-group">
            <div class="control-item">
                <label for="dateInput">Date</label>
                <input type="date" id="dateInput" class="date-input">
            </div>
            <div class="control-item">
                <button id="fetchBtn" class="fetch-btn">Get Schedule</button>
            </div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <div>Loading schedules...</div>
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div id="scheduleContainer" class="schedule-container">
        <button class="copy-btn" onclick="copyToClipboard('summaryOutput')">Copy Summary</button>
        <div id="summaryOutput" class="schedule-output"></div>
        
        <button class="copy-btn" onclick="copyToClipboard('breakdownOutput')">Copy Breakdown</button>
        <div id="breakdownOutput" class="breakdown-output"></div>
    </div>
</div>

<script>
const API_BASE = 'https://schedule.tommyek67.workers.dev/';
const SPORTS = ['mlb', 'nfl', 'wnba', 'ufc', 'soccer', 'cfb'];
const DISPLAY_NAMES = { soccer: 'FC' };

document.getElementById('dateInput').valueAsDate = new Date();
document.getElementById('fetchBtn').addEventListener('click', fetchAllSchedules);
document.getElementById('dateInput').addEventListener('keypress', e => { if(e.key==='Enter') fetchAllSchedules(); });

async function fetchAllSchedules() {
    const selectedDate = document.getElementById('dateInput').value;
    if (!selectedDate) { showError('Please select a date'); return; }

    showLoading(true); hideError(); hideSchedule();

    try {
        const promises = SPORTS.map(sport => fetchSportSchedule(sport, selectedDate));
        const results = await Promise.allSettled(promises);

        const sportsData = {};
        results.forEach((result, index) => {
            const sport = SPORTS[index];
            if (result.status==='fulfilled' && result.value) sportsData[sport] = result.value;
            else { console.warn(`Failed to fetch ${sport}:`, result.reason); sportsData[sport] = { content: { games: [] } }; }
        });

        displayConsolidatedSchedule(sportsData, selectedDate);
    } catch(err) {
        console.error('Fetch error:', err);
        showError(`Failed to load schedules: ${err.message}`);
    } finally { showLoading(false); }
}

async function fetchSportSchedule(sport, date) {
    const url = `${API_BASE}?sport=${sport}&day=${date}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Failed to fetch ${sport}: ${res.status}`);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    console.log(`${sport.toUpperCase()} API DATA:`, data);
    return data;
}

function getGamesFromData(data, sport) {
    if (!data) return [];
    if (data.content?.games) return data.content.games;
    if (Array.isArray(data.games)) return data.games;

    if (sport==='soccer') {
        const gamesArray = data.matches || data.events || data.content?.content?.games || [];
        return gamesArray.map(match => ({
            ...match,
            dateTime: match.dateTime || match.kickOffTime || match.start_time || match.startTime,
            homeTeam: match.homeTeam || { name: match.homeTeamName || 'Home' },
            awayTeam: match.awayTeam || { name: match.awayTeamName || 'Away' }
        }));
    }
    return [];
}

function displayConsolidatedSchedule(sportsData, selectedDate) {
    const container = document.getElementById('scheduleContainer');
    const summaryOutput = document.getElementById('summaryOutput');
    const breakdownOutput = document.getElementById('breakdownOutput');

    const allGames = [];
    const sportCounts = {};
    let totalGames = 0;

    Object.entries(sportsData).forEach(([sport, data])=>{
        const games = getGamesFromData(data, sport);
        if (games.length>0) {
            sportCounts[sport] = games.length;
            totalGames += games.length;
            games.forEach(game => allGames.push({ sport: DISPLAY_NAMES[sport]||sport.toUpperCase(), dateTime: game.dateTime, ...game }));
        }
    });

    summaryOutput.textContent = generateSummary(sportCounts, totalGames, selectedDate, sportsData);
    breakdownOutput.textContent = generateFullBreakdown(allGames);
    container.style.display = 'block';
}

function generateSummary(sportCounts, totalGames, selectedDate, sportsData) {
    const date = new Date(selectedDate+'T00:00:00');
    const dayName = date.toLocaleDateString('en-US',{weekday:'long'});
    const monthDay = date.toLocaleDateString('en-US',{month:'numeric',day:'numeric'});

    let summary = `Games on ${dayName} ${monthDay}\n———————————————\n`;

    if(totalGames===0) summary+='No games scheduled\n';
    else {
        const sortedSports = Object.entries(sportCounts).sort(([,a],[,b])=>b-a);
        sortedSports.forEach(([sport,count])=>{
            const times = getEarliestGameTimes(sport, sportsData);
            const displayName = DISPLAY_NAMES[sport]||sport.toUpperCase();
            summary += times.pdt && times.est ? `${count} ${displayName} (${times.pdt}/${times.est})\n` : `${count} ${displayName}\n`;
        });
    }

    summary += '———————————————\n';
    summary += `${totalGames} total games\n———————————————`;
    return summary;
}

function getEarliestGameTimes(sport, sportsData) {
    const games = getGamesFromData(sportsData[sport], sport);
    if(!games.length) return { pdt:'TBD', est:'TBD' };

    let earliestTime = null;
    games.forEach(game=>{
        const dt = game.dateTime || game.kickOffTime || game.startTime;
        if(dt) { const t=new Date(dt); if(!earliestTime||t<earliestTime) earliestTime=t; }
    });

    if(!earliestTime) return { pdt:'TBD', est:'TBD' };
    const pdt = earliestTime.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:false,timeZone:'America/Los_Angeles'});
    const est = earliestTime.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:false,timeZone:'America/New_York'});
    return { pdt: convertTo12Hour(pdt), est: convertTo12Hour(est) };
}

function generateFullBreakdown(allGames) {
    if(!allGames.length) return 'Full Breakdown: (EST)\nNo games scheduled';
    let breakdown='Full Breakdown: (EST)\n';
    const gamesByTime={};

    allGames.forEach(game=>{
        const dt = game.dateTime || game.kickOffTime || game.startTime;
        let timeKey='TBD';
        if(dt){ try{timeKey=new Date(dt).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:false,timeZone:'America/New_York'});} catch(e){timeKey='TBD';} }
        if(!gamesByTime[timeKey]) gamesByTime[timeKey]={};
        if(!gamesByTime[timeKey][game.sport]) gamesByTime[timeKey][game.sport]=0;
        gamesByTime[timeKey][game.sport]++;
    });

    const sortedTimes=Object.keys(gamesByTime).sort((a,b)=>{ if(a==='TBD') return 1; if(b==='TBD') return -1; return a.localeCompare(b); });
    const items=[];
    sortedTimes.forEach(time=>{
        const sports=gamesByTime[time];
        Object.entries(sports).forEach(([sport,count])=>{
            const displayTime=convertTo12Hour(time);
            items.push(count>1 ? `${sport} (${count}) - ${displayTime}` : `${sport} - ${displayTime}`);
        });
    });

    breakdown += items.join('\n');
    return breakdown;
}

function convertTo12Hour(time24) {
    if(time24==='TBD') return 'TBD';
    try{
        const [h,m]=time24.split(':'); const hour=parseInt(h); const ampm=hour>=12?'PM':'AM'; const dh=hour===0?12:(hour>12?hour-12:hour);
        return `${dh}:${m}${ampm}`;
    }catch(e){ return time24; }
}

function copyToClipboard(id){
    const txt=document.getElementById(id).textContent;
    navigator.clipboard.writeText(txt).then(()=>{
        const btn=event.target; const orig=btn.textContent;
        btn.textContent='Copied'; setTimeout(()=>{btn.textContent=orig;},1500);
    }).catch(err=>console.error('Failed to copy:',err));
}

function showLoading(show){document.getElementById('loading').style.display=show?'block':'none';}
function showError(msg){const e=document.getElementById('error'); e.textContent=msg; e.style.display='block';}
function hideError(){document.getElementById('error').style.display='none';}
function hideSchedule(){document.getElementById('scheduleContainer').style.display='none';}

fetchAllSchedules();
</script>
</body>
</html>
